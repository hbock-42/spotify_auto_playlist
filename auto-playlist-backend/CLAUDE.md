# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a TypeScript-based backend project for an auto-playlist Flutter application. It provides audio analysis services by integrating iTunes Search API for 30-second preview URLs and Essentia.js for audio feature extraction. The backend replaces Spotify's deprecated Audio Features API and uses tRPC for API handling with OpenAPI generation.

**Main Purpose**: Analyze audio features (energy, danceability, valence, tempo, acousticness) from iTunes preview URLs to help the Flutter app create intelligent playlists.

## Development Commands

- **Development server**: `pnpm dev` - Runs the development server using ts-node
- **Build**: `pnpm build` - Compiles TypeScript to JavaScript in dist/ directory
- **Start production**: `pnpm start` - Runs the compiled JavaScript from dist/
- **Generate OpenAPI**: `pnpm generate-openapi` - Generates OpenAPI documentation
- **Package manager**: Uses pnpm (version 10.13.1)

## Project Structure

- **Source code**: Expected in `src/` directory (currently empty)
- **Compiled output**: `dist/` directory (generated by TypeScript compiler)
- **Entry points**: 
  - Development: `src/server.ts`
  - Production: `dist/server.js`
  - OpenAPI generation: `src/generate-openapi.ts`

## Technology Stack

- **Runtime**: Node.js with TypeScript
- **API Framework**: tRPC with OpenAPI integration
- **Database**: Supabase (PostgreSQL) with sqlc for type-safe queries
- **Audio Analysis**: Essentia.js for feature extraction
- **External API**: iTunes Search API for 30-second preview URLs
- **Validation**: Zod for schema validation
- **Build**: TypeScript compiler targeting ES2020
- **Development**: ts-node for direct TypeScript execution
- **HTTP Client**: node-fetch/axios for iTunes API and audio streaming

## TypeScript Configuration

- **Target**: ES2020
- **Module**: CommonJS
- **Strict mode**: Enabled
- **Source directory**: `src/`
- **Output directory**: `dist/`

## API Integration Details

### Flutter App Integration
- **Input**: Receives track metadata (title, artist) from Flutter app
- **Output**: Returns audio features (energy, danceability, valence, tempo, acousticness)
- **Endpoints**: tRPC procedures for single track and batch analysis

### iTunes Search API
- **Rate Limit**: ~20 calls/minute (implement caching and rate limiting)
- **Attribution**: Must include "provided courtesy of iTunes" 
- **Usage**: Search by track title + artist to get 30-second preview URLs
- **Format**: Returns AAC audio files from Apple's CDN

### Database Schema
- **tracks**: Store track metadata and Spotify IDs
- **audio_features**: Store extracted audio features  
- **analysis_cache**: Cache iTunes search results and analysis
- **Use sqlc**: Generate type-safe TypeScript from SQL

### Performance Targets
- **Single track**: < 2 seconds analysis time
- **Batch processing**: 50 tracks in ~4 minutes
- **Cache hits**: < 100ms response time

## Notes

- Project is in initial setup phase - no source files exist yet
- Replaces deprecated Spotify Audio Features API (deprecated Nov 2024)
- Intelligent caching essential due to iTunes API rate limits
- Uses pnpm for package management

## Claude Working Principles

- When you are about to do a big task, use sequential-thinking mcp
- **Always verify library documentation**: Use context7 MCP to check the latest documentation for any library before implementation